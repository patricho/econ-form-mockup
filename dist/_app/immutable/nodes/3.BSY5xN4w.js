import{H as HttpError}from"../chunks/CYgJF_JY.js";import{a as add_form_reset_listener,f as forms,F as FormCellType,e as each,i as index,r as remove_input_defaults,b as set_value}from"../chunks/Dci5c_I7.js";import{f as from_html,a as append,t as text}from"../chunks/DJce7kAV.js";import{o as onMount}from"../chunks/CPIDdNNQ.js";import{B as set_active_reaction,C as set_active_effect,F as active_reaction,G as active_effect,al as is_runes,h as hydrating,u as untrack,am as render_effect,T as push,an as proxy,l as first_child,t as template_effect,V as pop,k as sibling,o as child,n as reset,q as get,v as user_derived}from"../chunks/DK7mhAu9.js";import{d as delegate,s as set_text}from"../chunks/B4QBEwBe.js";import{i as if_block}from"../chunks/DXwHyk5b.js";function without_reactive_context(e){var a=active_reaction,r=active_effect;set_active_reaction(null),set_active_effect(null);try{return e()}finally{set_active_reaction(a),set_active_effect(r)}}function listen_to_event_and_reset_event(e,a,r,o=r){e.addEventListener(a,()=>without_reactive_context(r));const n=e.__on_r;n?e.__on_r=()=>{n(),o(!0)}:e.__on_r=()=>o(!0),add_form_reset_listener()}function bind_value(e,a,r=a){var o=is_runes();listen_to_event_and_reset_event(e,"input",n=>{var i=n?e.defaultValue:e.value;if(i=is_numberlike_input(e)?to_number(i):i,r(i),o&&i!==(i=a())){var _=e.selectionStart,b=e.selectionEnd;e.value=i??"",b!==null&&(e.selectionStart=_,e.selectionEnd=Math.min(b,e.value.length))}}),(hydrating&&e.defaultValue!==e.value||untrack(a)==null&&e.value)&&r(is_numberlike_input(e)?to_number(e.value):e.value),render_effect(()=>{var n=a();is_numberlike_input(e)&&n===to_number(e.value)||e.type==="date"&&!n&&!e.value||n!==e.value&&(e.value=n??"")})}function is_numberlike_input(e){var a=e.type;return a==="number"||a==="range"}function to_number(e){return e===""?null:+e}function error(e,a){throw new HttpError(e,a)}new TextEncoder;const prerender=!0,load=({params:e})=>{const a=e.slug;if(!forms[a])throw error(404,`Form "${a}" not found`);let r=forms[a].cells||[],o=forms[a].rows||[],n=forms[a].columns||[],i=forms[a].transactions||[],_=forms[a].title||"";return{cells:r,rows:o,columns:n,transactions:i,title:_}};async function entries(){return Object.keys(forms).map(e=>({slug:e}))}const _page$1=Object.freeze(Object.defineProperty({__proto__:null,entries,load,prerender},Symbol.toStringTag,{value:"Module"})),AVG=(...e)=>e.reduce((o,n)=>o+n,0)/e.length||0,SUM=(...e)=>e.reduce((r,o)=>r+o,0);function getCellByAlias(e,a,r){var n;const o=a.find(i=>i.alias===r);if(o)return(n=e[o.y])==null?void 0:n[o.x]}function getCellValueNumberByAlias(e,a,r){const o=getCellByAlias(e,a,r);return parseFloat((o==null?void 0:o.value)||"0")||0}function validateFormula(e){return!0}function calculateCellFormula(cellValues,formCells,cell){if(!cell.formula)return"0";SUM(1,2,3,4),AVG(1,2,3,4),validateFormula(cell.formula);let formula=cell.formula;formula=formula.replace(/\{([A-Z]+\d+)\}/g,(e,a)=>getCellValueNumberByAlias(cellValues,formCells,a).toString());try{const result=eval(formula);return result.toString()}catch(e){return console.error("Formula evaluation error:",e,"Formula:",formula),"0"}}function calculateCellSum(e,a,r){var n;return(((n=r.dependencies)==null?void 0:n.reduce((i,_)=>i+getCellValueNumberByAlias(e,a,_),0))||0).toString()}var root_1=from_html('<div class="alert alert-info"><p>No form selected. Try: <a href="?form=test1" class="link">?form=test1</a></p></div>'),root_3=from_html("<th> </th>"),root_7=from_html('<input type="text" class="input text-right"/>'),root_9=from_html('<input type="text" class="input input-ghost text-right" disabled/>'),root_6=from_html('<fieldset class="fieldset"><!> <p class="label"> </p></fieldset>'),root_5=from_html('<td class="align-top"><!></td>'),root_4=from_html('<tr><th class="dark:text-stone-400"> </th><!></tr>'),root_2=from_html('<div class="rounded-box border-base-content/5 bg-base-100 overflow-x-auto border"><table class="table"><thead class="dark:text-stone-400"><tr><th></th><!></tr></thead><tbody></tbody></table></div> <hr/> <ul class="my-4"><li> </li></ul>',1),root=from_html('<h1 class="mb-4 text-2xl font-bold"> </h1> <hr/> <!>',1);function _page(e,a){var H,I;push(a,!0);let r=a.data.cells,o=a.data.rows,n=a.data.columns,i=a.data.transactions,_=a.data.title;const b=Math.max(...r.map(t=>t.x)),L=Math.max(...r.map(t=>t.y)),c=proxy([]);for(let t=0;t<=L;t++){c[t]=[];for(let l=0;l<=b;l++){const s=r.find(m=>m.x===l&&m.y===t);if(!s)continue;let u="";const d=s.transactionType||((H=o[t])==null?void 0:H.transactionType),T=s.transactionSource||((I=n[l])==null?void 0:I.transactionSource);if(d&&T){const m=i.find(k=>k.src.id==T.id&&k.type.id==d.id);m&&(u=m.value)}c[t][l]={value:u,cell:s}}}function O(t,l,s){if(c[l]&&c[l][t]){c[l][t].value=s;const u=c[l][t].cell.alias,d=new CustomEvent("cellchange",{detail:{alias:u,value:s,x:t,y:l,cell:c[l][t].cell}});document.dispatchEvent(d)}}function j(t){var u;if(!t.dependencies||t.dependencies.length===0)return;const l=(u=c[t.y])==null?void 0:u[t.x];if(!l)return;let s=l.value;t.type==FormCellType.FORMULA?s=calculateCellFormula(c,r,t):t.type==FormCellType.SUM&&(s=calculateCellSum(c,r,t)),l.value!==s&&(l.value=s,document.dispatchEvent(new CustomEvent("cellchange",{detail:{alias:t.alias,value:s,x:t.x,y:t.y,cell:l.cell}})))}function D(){r.forEach(t=>{var l;(l=t.dependencies)!=null&&l.length&&(document.addEventListener("cellchange",s=>{var u;(u=t.dependencies)!=null&&u.includes(s.detail.alias)&&j(t)}),j(t))})}onMount(()=>{D(),document.addEventListener("cellchange",t=>{console.log("Cell changed",t.detail.alias)})});var G=root(),N=first_child(G),J=child(N,!0);reset(N);var X=sibling(N,4);{var Y=t=>{var l=root_1();append(t,l)},Z=t=>{var l=root_2(),s=first_child(l),u=child(s),d=child(u),T=child(d),m=sibling(child(T));each(m,17,()=>({length:b+1}),index,(v,w,f)=>{var p=root_3(),E=child(p,!0);reset(p),template_effect(()=>{var A;return set_text(E,n[f].title||((A=n[f].transactionSource)==null?void 0:A.title)||"N/A")}),append(v,p)}),reset(T),reset(d);var k=sibling(d);each(k,21,()=>({length:L+1}),index,(v,w,f)=>{var p=root_4(),E=child(p),A=child(E,!0);reset(E);var Q=sibling(E);each(Q,17,()=>({length:b+1}),index,(y,le,x)=>{var U=root_5();const M=user_derived(()=>r.find(C=>C.x==x&&C.y==f));var W=child(U);{var $=C=>{var B=root_6(),q=child(B);{var ee=F=>{var h=root_7();remove_input_defaults(h),h.__input=g=>O(x,f,g.target.value),h.__change=g=>O(x,f,g.target.value),bind_value(h,()=>c[f][x].value,g=>c[f][x].value=g),append(F,h)},te=(F,h)=>{{var g=S=>{var V=root_9();remove_input_defaults(V),template_effect(()=>set_value(V,c[f][x].value)),append(S,V)},re=S=>{var V=text("wtf");append(S,V)};if_block(F,S=>{[FormCellType.STATIC,FormCellType.SUM,FormCellType.FORMULA].includes(get(M).type)?S(g):S(re,!1)},h)}};if_block(q,F=>{get(M).type==FormCellType.INPUT?F(ee):F(te,!1)})}var z=sibling(q,2),ae=child(z,!0);reset(z),reset(B),template_effect(()=>set_text(ae,get(M).legend)),append(C,B)};if_block(W,C=>{get(M)&&C($)})}reset(U),append(y,U)}),reset(p),template_effect(y=>set_text(A,y),[()=>{var y;return o[f].title||((y=o[f].transactionType)==null?void 0:y.title)||(f+1).toString()}]),append(v,p)}),reset(k),reset(u),reset(s);var R=sibling(s,4),P=child(R),K=child(P);reset(P),reset(R),template_effect(v=>set_text(K,`cellValues: ${v??""}`),[()=>JSON.stringify(c.map(v=>v.map(w=>({x:w.cell.x,y:w.cell.y,val:w.value}))))]),append(t,l)};if_block(X,t=>{r.length===0||c.length===0?t(Y):t(Z,!1)})}template_effect(()=>set_text(J,_)),append(e,G),pop()}delegate(["input","change"]);export{_page as component,_page$1 as universal};
