import{H as HttpError}from"../chunks/CYgJF_JY.js";import{a as add_form_reset_listener,f as forms,F as FormCellType,e as each,i as index,r as remove_input_defaults,b as set_value}from"../chunks/Dci5c_I7.js";import{f as from_html,a as append,t as text}from"../chunks/DJce7kAV.js";import{o as onMount}from"../chunks/CPIDdNNQ.js";import{B as set_active_reaction,C as set_active_effect,F as active_reaction,G as active_effect,al as is_runes,h as hydrating,u as untrack,am as render_effect,T as push,an as proxy,l as first_child,t as template_effect,V as pop,k as sibling,o as child,n as reset,q as get,v as user_derived}from"../chunks/DK7mhAu9.js";import{d as delegate,s as set_text}from"../chunks/B4QBEwBe.js";import{i as if_block}from"../chunks/DXwHyk5b.js";function without_reactive_context(e){var a=active_reaction,l=active_effect;set_active_reaction(null),set_active_effect(null);try{return e()}finally{set_active_reaction(a),set_active_effect(l)}}function listen_to_event_and_reset_event(e,a,l,n=l){e.addEventListener(a,()=>without_reactive_context(l));const o=e.__on_r;o?e.__on_r=()=>{o(),n(!0)}:e.__on_r=()=>n(!0),add_form_reset_listener()}function bind_value(e,a,l=a){var n=is_runes();listen_to_event_and_reset_event(e,"input",o=>{var i=o?e.defaultValue:e.value;if(i=is_numberlike_input(e)?to_number(i):i,l(i),n&&i!==(i=a())){var d=e.selectionStart,b=e.selectionEnd;e.value=i??"",b!==null&&(e.selectionStart=d,e.selectionEnd=Math.min(b,e.value.length))}}),(hydrating&&e.defaultValue!==e.value||untrack(a)==null&&e.value)&&l(is_numberlike_input(e)?to_number(e.value):e.value),render_effect(()=>{var o=a();is_numberlike_input(e)&&o===to_number(e.value)||e.type==="date"&&!o&&!e.value||o!==e.value&&(e.value=o??"")})}function is_numberlike_input(e){var a=e.type;return a==="number"||a==="range"}function to_number(e){return e===""?null:+e}function error(e,a){throw new HttpError(e,a)}new TextEncoder;const prerender=!0,load=({params:e})=>{const a=e.slug;if(!forms[a])throw error(404,`Form "${a}" not found`);let l=forms[a].cells||[],n=forms[a].rows||[],o=forms[a].columns||[],i=forms[a].transactions||[],d=forms[a].title||"";return{cells:l,rows:n,columns:o,transactions:i,title:d}};async function entries(){return Object.keys(forms).map(e=>({slug:e}))}const _page$1=Object.freeze(Object.defineProperty({__proto__:null,entries,load,prerender},Symbol.toStringTag,{value:"Module"}));function getCellByAlias(e,a,l){var o;const n=a.find(i=>i.alias===l);if(n)return(o=e[n.y])==null?void 0:o[n.x]}function getCellValueNumberByAlias(e,a,l){const n=getCellByAlias(e,a,l);return parseFloat((n==null?void 0:n.value)||"0")||0}function validateFormula(e){return!0}function calculateCellFormula(cellValues,formCells,cell){if(!cell.formula)return"0";validateFormula(cell.formula);let formula=cell.formula;formula=formula.replace(/\{([A-Z]+\d+)\}/g,(e,a)=>getCellValueNumberByAlias(cellValues,formCells,a).toString());try{const result=eval(formula);return result.toString()}catch(e){return console.error("Formula evaluation error:",e,"Formula:",formula),"0"}}function calculateCellSum(e,a,l){var o;return(((o=l.dependencies)==null?void 0:o.reduce((i,d)=>i+getCellValueNumberByAlias(e,a,d),0))||0).toString()}var root_1=from_html('<div class="alert alert-info"><p>No form selected. Try: <a href="?form=test1" class="link">?form=test1</a></p></div>'),root_3=from_html("<th> </th>"),root_7=from_html('<input type="text" class="input text-right"/>'),root_9=from_html('<input type="text" class="input input-ghost text-right" disabled/>'),root_6=from_html('<fieldset class="fieldset"><!> <p class="label"> </p></fieldset>'),root_5=from_html('<td class="align-top"><!></td>'),root_4=from_html('<tr><th class="dark:text-stone-400"> </th><!></tr>'),root_2=from_html('<div class="rounded-box border-base-content/5 bg-base-100 overflow-x-auto border"><table class="table"><thead class="dark:text-stone-400"><tr><th></th><!></tr></thead><tbody></tbody></table></div> <hr/> <ul class="my-4"><li> </li></ul>',1),root=from_html('<h1 class="mb-4 text-2xl font-bold"> </h1> <hr/> <!>',1);function _page(e,a){var I,R;push(a,!0);let l=a.data.cells,n=a.data.rows,o=a.data.columns,i=a.data.transactions,d=a.data.title;const b=Math.max(...l.map(t=>t.x)),O=Math.max(...l.map(t=>t.y)),c=proxy([]);for(let t=0;t<=O;t++){c[t]=[];for(let r=0;r<=b;r++){const s=l.find(v=>v.x===r&&v.y===t);if(!s)continue;let u="";const _=s.transactionType||((I=n[t])==null?void 0:I.transactionType),S=s.transactionSource||((R=o[r])==null?void 0:R.transactionSource);if(_&&S){const v=i.find(k=>k.src.id==S.id&&k.type.id==_.id);v&&(u=v.value)}c[t][r]={value:u,cell:s}}}function U(t,r,s){if(c[r]&&c[r][t]){c[r][t].value=s;const u=c[r][t].cell.alias,_=new CustomEvent("cellchange",{detail:{alias:u,value:s,x:t,y:r,cell:c[r][t].cell}});document.dispatchEvent(_)}}function j(t){var u;if(!t.dependencies||t.dependencies.length===0)return;const r=(u=c[t.y])==null?void 0:u[t.x];if(!r)return;let s=r.value;t.type==FormCellType.FORMULA?s=calculateCellFormula(c,l,t):t.type==FormCellType.SUM&&(s=calculateCellSum(c,l,t)),r.value!==s&&(r.value=s,document.dispatchEvent(new CustomEvent("cellchange",{detail:{alias:t.alias,value:s,x:t.x,y:t.y,cell:r.cell}})))}function G(){l.forEach(t=>{var r;(r=t.dependencies)!=null&&r.length&&(document.addEventListener("cellchange",s=>{var u;(u=t.dependencies)!=null&&u.includes(s.detail.alias)&&j(t)}),j(t))})}onMount(()=>{G(),document.addEventListener("cellchange",t=>{console.log("Cell changed",t.detail.alias)})});var H=root(),N=first_child(H),J=child(N,!0);reset(N);var X=sibling(N,4);{var Y=t=>{var r=root_1();append(t,r)},Z=t=>{var r=root_2(),s=first_child(r),u=child(s),_=child(u),S=child(_),v=sibling(child(S));each(v,17,()=>({length:b+1}),index,(m,w,f)=>{var p=root_3(),E=child(p,!0);reset(p),template_effect(()=>{var A;return set_text(E,o[f].title||((A=o[f].transactionSource)==null?void 0:A.title)||"N/A")}),append(m,p)}),reset(S),reset(_);var k=sibling(_);each(k,21,()=>({length:O+1}),index,(m,w,f)=>{var p=root_4(),E=child(p),A=child(E,!0);reset(E);var Q=sibling(E);each(Q,17,()=>({length:b+1}),index,(y,le,x)=>{var B=root_5();const M=user_derived(()=>l.find(C=>C.x==x&&C.y==f));var W=child(B);{var $=C=>{var L=root_6(),z=child(L);{var ee=F=>{var h=root_7();remove_input_defaults(h),h.__input=g=>U(x,f,g.target.value),h.__change=g=>U(x,f,g.target.value),bind_value(h,()=>c[f][x].value,g=>c[f][x].value=g),append(F,h)},te=(F,h)=>{{var g=T=>{var V=root_9();remove_input_defaults(V),template_effect(()=>set_value(V,c[f][x].value)),append(T,V)},re=T=>{var V=text("wtf");append(T,V)};if_block(F,T=>{[FormCellType.STATIC,FormCellType.SUM,FormCellType.FORMULA].includes(get(M).type)?T(g):T(re,!1)},h)}};if_block(z,F=>{get(M).type==FormCellType.INPUT?F(ee):F(te,!1)})}var D=sibling(z,2),ae=child(D,!0);reset(D),reset(L),template_effect(()=>set_text(ae,get(M).legend)),append(C,L)};if_block(W,C=>{get(M)&&C($)})}reset(B),append(y,B)}),reset(p),template_effect(y=>set_text(A,y),[()=>{var y;return n[f].title||((y=n[f].transactionType)==null?void 0:y.title)||(f+1).toString()}]),append(m,p)}),reset(k),reset(u),reset(s);var P=sibling(s,4),q=child(P),K=child(q);reset(q),reset(P),template_effect(m=>set_text(K,`cellValues: ${m??""}`),[()=>JSON.stringify(c.map(m=>m.map(w=>({x:w.cell.x,y:w.cell.y,val:w.value}))))]),append(t,r)};if_block(X,t=>{l.length===0||c.length===0?t(Y):t(Z,!1)})}template_effect(()=>set_text(J,d)),append(e,H),pop()}delegate(["input","change"]);export{_page as component,_page$1 as universal};
