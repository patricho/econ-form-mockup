import{e as error,a as bind_value}from"../chunks/B2G9yGqO.js";import{f as forms,F as FormCellType,e as each,i as index,r as remove_input_defaults,u as set_value}from"../chunks/DFoSPvyq.js";import{f as from_html,a as append,t as text}from"../chunks/CXwe6nxK.js";import{o as onMount}from"../chunks/CV6SLrEf.js";import{x as push,a4 as proxy,l as first_child,t as template_effect,y as pop,k as sibling,o as child,n as reset,q as get,v as user_derived}from"../chunks/z3Ghawec.js";import{d as delegate,s as set_text}from"../chunks/Fs0No55i.js";import{i as if_block}from"../chunks/43kEz1_o.js";const prerender=!0,load=({params:r})=>{const a=r.slug;if(!forms[a])throw error(404,`Form "${a}" not found`);let o=forms[a].cells||[],s=forms[a].rows||[],c=forms[a].columns||[],f=forms[a].transactions||[],S=forms[a].title||"";return{cells:o,rows:s,columns:c,transactions:f,title:S}};async function entries(){return Object.keys(forms).map(r=>({slug:r}))}const _page$1=Object.freeze(Object.defineProperty({__proto__:null,entries,load,prerender},Symbol.toStringTag,{value:"Module"})),AVG=(...r)=>r.reduce((s,c)=>s+c,0)/r.length||0,SUM=(...r)=>r.reduce((o,s)=>o+s,0);function getCellByAlias(r,a,o){var c;const s=a.find(f=>f.alias===o);if(s)return(c=r[s.y])==null?void 0:c[s.x]}function getCellValueNumberByAlias(r,a,o){const s=getCellByAlias(r,a,o);return parseFloat((s==null?void 0:s.value)||"0")||0}function validateFormula(r){return!0}function calculateCellFormula(cellValues,formCells,cell){if(!cell.formula)return"0";SUM(1,2,3,4),AVG(1,2,3,4),validateFormula(cell.formula);let formula=cell.formula;formula=formula.replace(/\{([A-Z]+\d+)\}/g,(r,a)=>getCellValueNumberByAlias(cellValues,formCells,a).toString());try{const result=eval(formula);return result.toString()}catch(r){return console.error("Formula evaluation error:",r,"Formula:",formula),"0"}}function calculateCellSum(r,a,o){var c;return(((c=o.dependencies)==null?void 0:c.reduce((f,S)=>f+getCellValueNumberByAlias(r,a,S),0))||0).toString()}var root_1=from_html('<div class="alert alert-info"><p>No form selected. Try: <a href="?form=test1" class="link">?form=test1</a></p></div>'),root_3=from_html("<th> </th>"),root_7=from_html('<input type="text" class="input text-right"/>'),root_9=from_html('<input type="text" class="input input-ghost text-right" disabled/>'),root_6=from_html('<fieldset class="fieldset"><!> <p class="label"> </p></fieldset>'),root_5=from_html('<td class="align-top"><!></td>'),root_4=from_html('<tr><th class="dark:text-stone-400"> </th><!></tr>'),root_2=from_html('<div class="rounded-box border-base-content/5 bg-base-100 overflow-x-auto border"><table class="table"><thead class="dark:text-stone-400"><tr><th></th><!></tr></thead><tbody></tbody></table></div> <hr/> <ul class="my-4"><li> </li></ul>',1),root=from_html('<h1 class="mb-4 text-2xl font-bold"> </h1> <hr/> <!>',1);function _page(r,a){var P,q;push(a,!0);let o=a.data.cells,s=a.data.rows,c=a.data.columns,f=a.data.transactions,S=a.data.title;const U=Math.max(...o.map(e=>e.x)),j=Math.max(...o.map(e=>e.y)),n=proxy([]);for(let e=0;e<=j;e++){n[e]=[];for(let t=0;t<=U;t++){const l=o.find(m=>m.x===t&&m.y===e);if(!l)continue;let i="";const d=l.transactionType||((P=s[e])==null?void 0:P.transactionType),T=l.transactionSource||((q=c[t])==null?void 0:q.transactionSource);if(d&&T){const m=f.find(A=>A.src.id==T.id&&A.type.id==d.id);m&&(i=m.value)}else l.value&&(i=l.value);n[e][t]={value:i,cell:l}}}function I(e,t,l){if(n[t]&&n[t][e]){n[t][e].value=l;const i=n[t][e].cell.alias,d=new CustomEvent("cellchange",{detail:{alias:i,value:l,x:e,y:t,cell:n[t][e].cell}});document.dispatchEvent(d)}}function R(e){var i;if(!e.dependencies||e.dependencies.length===0)return;const t=(i=n[e.y])==null?void 0:i[e.x];if(!t)return;let l=t.value;e.type==FormCellType.FORMULA?l=calculateCellFormula(n,o,e):e.type==FormCellType.SUM&&(l=calculateCellSum(n,o,e)),t.value!==l&&(t.value=l,document.dispatchEvent(new CustomEvent("cellchange",{detail:{alias:e.alias,value:l,x:e.x,y:e.y,cell:t.cell}})))}function Y(){o.forEach(e=>{var t;(t=e.dependencies)!=null&&t.length&&(document.addEventListener("cellchange",l=>{var i;(i=e.dependencies)!=null&&i.includes(l.detail.alias)&&R(e)}),R(e))})}onMount(()=>{Y(),document.addEventListener("cellchange",e=>{console.log("Cell changed",e.detail.alias)})});var G=root(),O=first_child(G),Z=child(O,!0);reset(O);var H=sibling(O,4);{var K=e=>{var t=root_1();append(e,t)},Q=e=>{var t=root_2(),l=first_child(t),i=child(l),d=child(i),T=child(d),m=sibling(child(T));each(m,17,()=>({length:U+1}),index,(p,k,u)=>{var v=root_3(),M=child(v,!0);reset(v),template_effect(()=>{var E;return set_text(M,c[u].title||((E=c[u].transactionSource)==null?void 0:E.title)||"N/A")}),append(p,v)}),reset(T),reset(d);var A=sibling(d);each(A,21,()=>({length:j+1}),index,(p,k,u)=>{var v=root_4(),M=child(v),E=child(M,!0);reset(M);var $=sibling(M);each($,17,()=>({length:U+1}),index,(b,ie,_)=>{var B=root_5();const w=user_derived(()=>o.find(x=>x.x==_&&x.y==u));var ee=child(B);{var te=x=>{var L=root_6(),J=child(L);{var ae=y=>{var h=root_7();remove_input_defaults(h),h.__input=g=>I(_,u,g.target.value),h.__change=g=>I(_,u,g.target.value),bind_value(h,()=>n[u][_].value,g=>n[u][_].value=g),append(y,h)},le=(y,h)=>{{var g=C=>{var V=root_9();remove_input_defaults(V),template_effect(()=>set_value(V,n[u][_].value)),append(C,V)},oe=(C,V)=>{{var se=F=>{var N=text();template_effect(()=>set_text(N,n[u][_].value)),append(F,N)},ne=F=>{var N=text("wtf");append(F,N)};if_block(C,F=>{[FormCellType.STATIC].includes(get(w).type)?F(se):F(ne,!1)},V)}};if_block(y,C=>{[FormCellType.SUM,FormCellType.FORMULA].includes(get(w).type)?C(g):C(oe,!1)},h)}};if_block(J,y=>{get(w).type==FormCellType.INPUT?y(ae):y(le,!1)})}var X=sibling(J,2),re=child(X,!0);reset(X),reset(L),template_effect(()=>set_text(re,get(w).legend)),append(x,L)};if_block(ee,x=>{get(w)&&x(te)})}reset(B),append(b,B)}),reset(v),template_effect(b=>set_text(E,b),[()=>{var b;return s[u].title||((b=s[u].transactionType)==null?void 0:b.title)||(u+1).toString()}]),append(p,v)}),reset(A),reset(i),reset(l);var z=sibling(l,4),D=child(z),W=child(D);reset(D),reset(z),template_effect(p=>set_text(W,`cellValues: ${p??""}`),[()=>JSON.stringify(n.map(p=>p.map(k=>({x:k.cell.x,y:k.cell.y,val:k.value}))))]),append(e,t)};if_block(H,e=>{o.length===0||n.length===0?e(K):e(Q,!1)})}template_effect(()=>set_text(Z,S)),append(r,G),pop()}delegate(["input","change"]);export{_page as component,_page$1 as universal};
